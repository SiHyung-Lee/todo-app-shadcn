<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Supabase 연결 테스트</title>
</head>
<body>
    <h1>Supabase 연결 테스트</h1>
    <div id="status">연결 중...</div>
    <div id="result"></div>
    
    <h2>테이블 생성 SQL</h2>
    <pre style="background: #f0f0f0; padding: 20px; border-radius: 5px;">
-- 1. Supabase SQL Editor에서 이 SQL을 실행하세요:

-- 기존 테이블 삭제 (있다면)
DROP TABLE IF EXISTS todos;

-- todos 테이블 생성
CREATE TABLE todos (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  text TEXT NOT NULL,
  completed BOOLEAN DEFAULT false,
  priority VARCHAR(10) DEFAULT 'medium',
  category VARCHAR(50) DEFAULT '개인',
  starred BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스 생성
CREATE INDEX idx_todos_created_at ON todos(created_at DESC);
CREATE INDEX idx_todos_category ON todos(category);
CREATE INDEX idx_todos_starred ON todos(starred);

-- RLS 활성화
ALTER TABLE todos ENABLE ROW LEVEL SECURITY;

-- 모든 작업 허용 정책
CREATE POLICY "Allow all operations on todos" ON todos
  FOR ALL USING (true) WITH CHECK (true);

-- updated_at 자동 업데이트 함수
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- 트리거 생성
CREATE TRIGGER update_todos_updated_at 
  BEFORE UPDATE ON todos 
  FOR EACH ROW 
  EXECUTE PROCEDURE update_updated_at_column();

-- 2. 테스트 데이터 삽입 (선택사항)
INSERT INTO todos (text, completed, priority, category, starred) 
VALUES 
  ('Supabase 연동 테스트', false, 'high', '개발', true),
  ('Pro 버전 기능 확인', false, 'medium', '개발', false);
    </pre>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        const supabaseUrl = 'https://zuesdeadfmbhmksqlsao.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1ZXNkZWFkZm1iaG1rc3Fsc2FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NDAxNTUsImV4cCI6MjA3MTMxNjE1NX0.9DcnOLDkT3zgVZsrQ37ggbHI-94dBq7xM2lTBDtvc4I'
        
        const supabase = createClient(supabaseUrl, supabaseKey)
        
        async function testConnection() {
            const statusEl = document.getElementById('status')
            const resultEl = document.getElementById('result')
            
            try {
                // 1. 연결 테스트
                statusEl.innerHTML = '✅ Supabase 연결 성공!<br>todos 테이블 확인 중...'
                
                // 2. todos 테이블 조회
                const { data, error } = await supabase
                    .from('todos')
                    .select('*')
                    .limit(5)
                
                if (error) {
                    statusEl.innerHTML += '<br>❌ 테이블 조회 실패!'
                    resultEl.innerHTML = `
                        <h3 style="color: red;">에러 발생:</h3>
                        <pre style="background: #ffe0e0; padding: 10px; border-radius: 5px;">
${JSON.stringify(error, null, 2)}

${error.code === '42P01' ? '⚠️ todos 테이블이 없습니다! 위의 SQL을 Supabase에서 실행하세요.' : ''}
${error.code === 'PGRST301' ? '⚠️ todos 테이블이 없거나 RLS 정책이 설정되지 않았습니다!' : ''}
                        </pre>
                    `
                } else {
                    statusEl.innerHTML += '<br>✅ 테이블 조회 성공!'
                    resultEl.innerHTML = `
                        <h3 style="color: green;">todos 테이블 데이터 (${data.length}개):</h3>
                        <pre style="background: #e0ffe0; padding: 10px; border-radius: 5px;">
${JSON.stringify(data, null, 2)}
                        </pre>
                        <p>✅ Supabase가 정상적으로 연동되었습니다!</p>
                    `
                }
            } catch (err) {
                statusEl.innerHTML = '❌ 연결 실패!'
                resultEl.innerHTML = `<pre style="color: red;">${err}</pre>`
            }
        }
        
        testConnection()
    </script>
</body>
</html>